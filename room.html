<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ«ãƒ¼ãƒ </title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase SDKã‚’èª­ã¿è¾¼ã¿ -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js"></script>
</head>
<body>
  <h1>ã‚«ã‚¿ã‚«ãƒŠã‚¯ã‚¤ã‚ºï¼šãƒ«ãƒ¼ãƒ </h1>
  <div id="info"></div>
  <div id="questionArea"></div>
  <div id="players"></div>
  <div id="controls"></div>

  <script>
    // Firebaseã®è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBnNXAZlKVMIT6DMeOqOF_jVn2EKLOYBww",
      authDomain: "katakana-db0a4.firebaseapp.com",
      databaseURL: "https://katakana-db0a4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "katakana-db0a4",
      storageBucket: "katakana-db0a4.firebasestorage.app",
      messagingSenderId: "356896375162",
      appId: "1:356896375162:web:a96bec82ca7ab440d996c3"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const roomID = localStorage.getItem("roomID");
    const playerName = localStorage.getItem("playerName");

    let players = [];
    let scores = {};
    let usedIndexes = [];
    let currentQuestion = "";
    let currentIndex = -1;
    let answerOrder = [];
    let isHost = false;

    const roomRef = db.ref("rooms/" + roomID);

    if (!roomID || !playerName) {
      alert("å‚åŠ æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚join.htmlã‹ã‚‰å‚åŠ ã—ã¦ãã ã•ã„");
      location.href = "join.html";
    }

    // Firebaseã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²
    roomRef.child("players").push(playerName);

    // Firebaseã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ï¼‰
    roomRef.child("players").on("value", snapshot => {
      const firebasePlayers = snapshot.val();
      if (firebasePlayers) {
        players = Object.values(firebasePlayers);
        updateDisplay();
      }
    });

    // ã‚¹ã‚³ã‚¢ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰ â€»å¾Œã§Firebaseå¯¾å¿œã‚‚å¯èƒ½
    if (!localStorage.getItem("scores_" + roomID)) {
      scores[playerName] = 0;
      localStorage.setItem("scores_" + roomID, JSON.stringify(scores));
    } else {
      scores = JSON.parse(localStorage.getItem("scores_" + roomID));
      if (!scores[playerName]) {
        scores[playerName] = 0;
        localStorage.setItem("scores_" + roomID, JSON.stringify(scores));
      }
    }

    function updateDisplay() {
      document.getElementById("info").innerHTML = `<h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§</h2>` + players.map(p => {
        const score = scores[p] ?? 0;
        return `<div>${p}ï¼š${score}ç‚¹
          <button onclick="changeScore('${p}', 1)">ï¼‹</button>
          <button onclick="changeScore('${p}', -1)">ï¼</button>
        </div>`;
      }).join("");

      if (currentQuestion) {
        document.getElementById("questionArea").innerHTML = `<h3>ãŠé¡Œ: ${currentQuestion}</h3>`;
      }

      document.getElementById("controls").innerHTML = isHost ? `
        <button onclick="nextQuestion()">æ¬¡ã®å‡ºé¡Œ</button>
        <button onclick="judge(true)">æ­£è§£</button>
        <button onclick="judge(false)">ä¸æ­£è§£</button>
      ` : `<button onclick="answer()">å›ç­”ã™ã‚‹</button>`;
    }

    function nextQuestion() {
      fetch("quiz.json").then(res => res.json()).then(data => {
        do {
          currentIndex = Math.floor(Math.random() * data.length);
        } while (usedIndexes.includes(currentIndex));
        usedIndexes.push(currentIndex);
        currentQuestion = data[currentIndex].question;
        answerOrder = [];
        updateDisplay();
      });
    }

    function answer() {
      if (!answerOrder.includes(playerName)) {
        answerOrder.push(playerName);
        alert(`${playerName}ãŒå›ç­”ã—ã¾ã—ãŸï¼ï¼ˆé †ç•ª${answerOrder.length}ç•ªç›®ï¼‰`);
      }
    }

    function judge(correct) {
      if (answerOrder.length === 0) {
        alert("èª°ã‚‚å›ç­”ã—ã¦ã„ã¾ã›ã‚“");
        return;
      }
      const current = answerOrder.shift();
      if (correct) {
        scores[current]++;
        scores[playerName]++;
        alert(`${current}ãŒæ­£è§£ï¼`);
      } else {
        alert(`${current}ã¯ä¸æ­£è§£`);
      }
      checkWinner();
      updateDisplay();
    }

    function changeScore(name, delta) {
      scores[name] = (scores[name] ?? 0) + delta;
      localStorage.setItem("scores_" + roomID, JSON.stringify(scores));
      updateDisplay();
    }

    function checkWinner() {
      for (const [name, score] of Object.entries(scores)) {
        if (score >= 10) {
          alert(`${name}ãŒ10ç‚¹ã«åˆ°é”ï¼å„ªå‹ã§ã™ğŸ‰`);
        }
      }
    }

    updateDisplay();
  </script>
</body>
</html>
