<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ルーム</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase SDKを読み込み -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js"></script>
</head>
<body>
  <h1>カタカナクイズ：ルーム</h1>
  <div id="info"></div>
  <div id="questionArea"></div>
  <div id="players"></div>
  <div id="controls"></div>

  <script>
    // Firebaseの設定
    const firebaseConfig = {
      apiKey: "AIzaSyBnNXAZlKVMIT6DMeOqOF_jVn2EKLOYBww",
      authDomain: "katakana-db0a4.firebaseapp.com",
      databaseURL: "https://katakana-db0a4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "katakana-db0a4",
      storageBucket: "katakana-db0a4.firebasestorage.app",
      messagingSenderId: "356896375162",
      appId: "1:356896375162:web:a96bec82ca7ab440d996c3"
    };

    // Firebase初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const roomID = localStorage.getItem("roomID");
    const playerName = localStorage.getItem("playerName");

    let players = [];
    let scores = {};
    let usedIndexes = [];
    let currentQuestion = "";
    let currentIndex = -1;
    let answerOrder = [];
    let isHost = false;

    const roomRef = db.ref("rooms/" + roomID);

    if (!roomID || !playerName) {
      alert("参加情報がありません。join.htmlから参加してください");
      location.href = "join.html";
    }

    // Firebaseにプレイヤー登録
    roomRef.child("players").push(playerName);

    // Firebaseからプレイヤー一覧を取得（リアルタイム反映）
    roomRef.child("players").on("value", snapshot => {
      const firebasePlayers = snapshot.val();
      if (firebasePlayers) {
        players = Object.values(firebasePlayers);
        updateDisplay();
      }
    });

    // スコアはローカル管理（簡易版） ※後でFirebase対応も可能
    if (!localStorage.getItem("scores_" + roomID)) {
      scores[playerName] = 0;
      localStorage.setItem("scores_" + roomID, JSON.stringify(scores));
    } else {
      scores = JSON.parse(localStorage.getItem("scores_" + roomID));
      if (!scores[playerName]) {
        scores[playerName] = 0;
        localStorage.setItem("scores_" + roomID, JSON.stringify(scores));
      }
    }

    function updateDisplay() {
      document.getElementById("info").innerHTML = `<h2>プレイヤー一覧</h2>` + players.map(p => {
        const score = scores[p] ?? 0;
        return `<div>${p}：${score}点
          <button onclick="changeScore('${p}', 1)">＋</button>
          <button onclick="changeScore('${p}', -1)">－</button>
        </div>`;
      }).join("");

      if (currentQuestion) {
        document.getElementById("questionArea").innerHTML = `<h3>お題: ${currentQuestion}</h3>`;
      }

      document.getElementById("controls").innerHTML = isHost ? `
        <button onclick="nextQuestion()">次の出題</button>
        <button onclick="judge(true)">正解</button>
        <button onclick="judge(false)">不正解</button>
      ` : `<button onclick="answer()">回答する</button>`;
    }

    function nextQuestion() {
      fetch("quiz.json").then(res => res.json()).then(data => {
        do {
          currentIndex = Math.floor(Math.random() * data.length);
        } while (usedIndexes.includes(currentIndex));
        usedIndexes.push(currentIndex);
        currentQuestion = data[currentIndex].question;
        answerOrder = [];
        updateDisplay();
      });
    }

    function answer() {
      if (!answerOrder.includes(playerName)) {
        answerOrder.push(playerName);
        alert(`${playerName}が回答しました！（順番${answerOrder.length}番目）`);
      }
    }

    function judge(correct) {
      if (answerOrder.length === 0) {
        alert("誰も回答していません");
        return;
      }
      const current = answerOrder.shift();
      if (correct) {
        scores[current]++;
        scores[playerName]++;
        alert(`${current}が正解！`);
      } else {
        alert(`${current}は不正解`);
      }
      checkWinner();
      updateDisplay();
    }

    function changeScore(name, delta) {
      scores[name] = (scores[name] ?? 0) + delta;
      localStorage.setItem("scores_" + roomID, JSON.stringify(scores));
      updateDisplay();
    }

    function checkWinner() {
      for (const [name, score] of Object.entries(scores)) {
        if (score >= 10) {
          alert(`${name}が10点に到達！優勝です🎉`);
        }
      }
    }

    updateDisplay();
  </script>
</body>
</html>
